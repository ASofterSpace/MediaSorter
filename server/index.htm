<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Link Archive</title>
	<meta name="keywords" content="link,archive,search">
	<meta name="description" content="Our link archive, which allows lookup / search for known archived links.">
	<script src="data.js"></script>
	<style>
		body {
			background: linear-gradient(-44deg, #160022, #202, #11001A, #202, #201, #202, #222, #202, #11001A, #201, #202, #112, #101, #11001A, #202, #160022, #212, #11001A, #101, #11001A, #202);
			color: rgb(136, 170, 255);
			min-height: 1024px;
		}
		h2 {
			font-size: 120%;
		}
		input {
			color: rgb(136, 170, 255);
			background: #202;
			border: 1px #55F solid;
			border-radius: 5pt;
		}
		button {
			color: rgb(146, 190, 255);
			background: #225;
			border: 1px #55F solid;
			border-radius: 5pt;
			cursor: pointer;
			margin-top: 1pt;
		}
		button:hover {
			background: #337;
		}
		a {
			color: rgb(136, 170, 255);
			text-decoration: none;
		}
		a:visited {
			color: rgb(170, 136, 255);
			text-decoration: none;
		}
		a:hover {
			color: rgb(156, 208, 255);
			text-decoration: underline;
		}
		div#searchBar > input {
			width: 80%;
			display: inline;
		}
		div#searchBar > button {
			width: 15%;
			display: inline;
			float: right;
		}
		div#statusBar {
			font-size: 10pt;
			font-style: italic;
			color: #0D0;
			font-family: "Courier New";
		}
	</style>
</head>

<body>

	<div id="searchBar">
		<input type="text" id="searchField"></input>
		<button onclick="doSearch();">Search</button>
	</div>

	<div id="outputArea">
	</div>

	<div style="padding-top: 20pt;" id="statusBar">
		Status: <span id="statusLabel">Loading data...</span>
	</div>

<script>
window.data = {

};

// transforms https://www.foo.org/bar?foo=bar
// info foo.org/bar
window.normalizeURI = function(uri) {
	uri = uri.toLowerCase();
	if (uri.indexOf("https://") == 0) {
		uri = uri.substring(8);
	}
	if (uri.indexOf("http://") == 0) {
		uri = uri.substring(7);
	}
	if (uri.indexOf("www.") == 0) {
		uri = uri.substring(4);
	}
	var questIndex = uri.indexOf("?");
	if (questIndex >= 0) {
		uri = uri.substring(0, questIndex);
	}
	return uri;
};

window.displayLocalLink = function(linkStr) {
	if ((linkStr.indexOf("http://") == 0) || (linkStr.indexOf("https://") == 0) ||
		(linkStr.indexOf("file://") == 0)) {
		return "<a href=\"" + linkStr + "\" target=\"_blank\">" + decodeURIComponent(linkStr) + "</a>";
	}
	return linkStr;
};

window.doSearch = function() {
	var needle = document.getElementById("searchField").value;
	var foundLinks = [];

	/*
	// search for links
	if (needle.indexOf("*") == 0) {
		needle = needle.substring(1);
		if (needle.lastIndexOf("*") == needle.length - 1) {
			// *needle*: contains needle
			needle = needle.substring(0, needle.length - 1);
			needle = normalizeURI(needle);
			for (var i = 0; i < data.links.length; i++) {
				var curLink = data.links[i];
				if (curLink.u.indexOf(needle) >= 0) {
					foundLinks.push(curLink);
				}
			}
		} else {
			// *needle: ends with needle
			needle = normalizeURI(needle);
			for (var i = 0; i < data.links.length; i++) {
				var curLink = data.links[i];
				if (curLink.u.lastIndexOf(needle) == curLink.u.length - needle.length) {
					foundLinks.push(curLink);
				}
			}
		}
	} else {
		if (needle.lastIndexOf("*") == needle.length - 1) {
			// needle*: starts with needle
			needle = needle.substring(0, needle.length - 1);
			needle = normalizeURI(needle);
			for (var i = 0; i < data.links.length; i++) {
				var curLink = data.links[i];
				if (curLink.u.indexOf(needle) == 0) {
					foundLinks.push(curLink);
				}
			}
		} else {
			// needle: is exactly needle
			needle = normalizeURI(needle);
			for (var i = 0; i < data.links.length; i++) {
				var curLink = data.links[i];
				if (curLink.u == needle) {
					foundLinks.push(curLink);
				}
			}
		}
	}
	*/

	// actually - just always check *needle*, no need to enter asterisks ^^'
	needle = normalizeURI(needle);
	for (var i = 0; i < data.links.length; i++) {
		var curLink = data.links[i];
		if (curLink.u.indexOf(needle) >= 0) {
			foundLinks.push(curLink);
		}
	}

	// sort results
	var foundSources = [];
	var foundReferences = [];
	for (var i = 0; i < foundLinks.length; i++) {
		var curLink = foundLinks[i];
		for (var si = 0; si < curLink.s.length; si++) {
			if (!foundSources.includes(curLink.s[si])) {
				foundSources.push(curLink.s[si]);
			}
		}
		for (var ri = 0; ri < curLink.r.length; ri++) {
			if (!foundReferences.includes(curLink.r[ri])) {
				foundReferences.push(curLink.r[ri]);
			}
		}
	}
	foundSources.sort();
	foundReferences.sort();

	// assemble results
	var htmlSources = "";
	var htmlRefs = "";
	for (var i = 0; i < foundSources.length; i++) {
		htmlSources += "<div>";
		htmlSources += displayLocalLink(foundSources[i]);
		htmlSources += "</div>";
	}
	for (var i = 0; i < foundReferences.length; i++) {
		htmlRefs += "<div>";
		htmlRefs += displayLocalLink(foundReferences[i]);
		htmlRefs += "</div>";
	}

	var html = ""
	if (htmlSources.length > 0) {
		html += "<h2>Sources:</h2>" + htmlSources;
	}
	if (htmlRefs.length > 0) {
		html += "<h2>References:</h2>" + htmlRefs;
	}
	if (html.length == 0) {
		html = "The URL cannot be found in our archive :/";
	}
	document.getElementById("outputArea").innerHTML = html;
};

// load and normalize all links
window.attemptToLoadData = function() {
	if (window.links) {
		var loadedLinks = [];
		for (var i = 0; i < window.links.length; i++) {
			var curLink = window.links[i];
			curLink.u = normalizeURI(curLink.u);
			loadedLinks.push(curLink);
		}
		window.data.links = loadedLinks;

		var statusLabel = document.getElementById("statusLabel");
		statusLabel.innerText = "Ready";
	} else {
		window.setTimeout(attemptToLoadData, 1000);
	}
};

var searchFieldElem = document.getElementById('searchField');
if (searchFieldElem) {
	searchFieldElem.onkeydown = function(event){
		if (event.key === 'Enter') {
			doSearch();
		}
	};
}

window.setTimeout(attemptToLoadData, 1000);
</script>
</body>
</html>
